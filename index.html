<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melez Pro Video Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1f1f1f;
            --bg-hover: #2a2a2a;
            --border: #333;
            --text: #fff;
            --text-secondary: #999;
            --accent: #e50914;
            --accent-hover: #ff0a16;
            --success: #46d369;
            --warning: #e87c03;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            overflow: hidden;
        }

        /* Layout */
        .studio {
            display: grid;
            grid-template-rows: 50px 1fr 200px;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .logo {
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover { background: var(--accent-hover); }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--bg-hover); }

        /* Main Workspace */
        .workspace {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            overflow: hidden;
        }

        /* Panels */
        .panel {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel:last-child { border-right: none; border-left: 1px solid var(--border); }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Preview Area */
        .preview-area {
            display: flex;
            flex-direction: column;
            background: #000;
        }

        .preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #previewCanvas {
            max-width: 100%;
            max-height: 100%;
            background: #000;
        }

        .preview-controls {
            height: 60px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }

        .time-display {
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .scrubber {
            flex: 1;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .scrubber-progress {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            width: 0%;
        }

        .scrubber-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            left: 0%;
        }

        /* Timeline */
        .timeline {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .timeline-toolbar {
            height: 40px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
        }

        .timeline-tracks {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .track {
            height: 50px;
            display: flex;
            margin-bottom: 5px;
        }

        .track-header {
            width: 100px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-right: 1px solid var(--border);
        }

        .track-content {
            flex: 1;
            background: var(--bg-tertiary);
            position: relative;
            overflow: hidden;
        }

        .clip {
            position: absolute;
            height: 100%;
            background: linear-gradient(135deg, var(--accent), #b20710);
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.8rem;
            cursor: move;
            overflow: hidden;
            white-space: nowrap;
        }

        .clip:hover { filter: brightness(1.2); }

        .clip.selected { box-shadow: 0 0 0 2px #fff; }

        /* Media Library */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .media-item {
            aspect-ratio: 16/9;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }

        .media-item:hover { border-color: var(--accent); }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 5px;
            background: rgba(0,0,0,0.8);
            font-size: 0.7rem;
            text-align: center;
        }

        /* Effects Panel */
        .effect-category {
            margin-bottom: 20px;
        }

        .effect-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .effect-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .effect-item {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            gap: 5px;
            border: 1px solid transparent;
        }

        .effect-item:hover { border-color: var(--accent); }
        .effect-item.active { background: var(--accent); }

        /* Properties */
        .property-group {
            margin-bottom: 20px;
        }

        .property-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        /* Progress */
        .progress-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .progress-overlay.active { display: flex; }

        .progress-bar {
            width: 400px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        /* Form Elements */
        input, textarea, select {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }

        textarea { min-height: 100px; resize: vertical; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Loading */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* AI Panel */
        .ai-prompt-box {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .generate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent), #ff6b6b);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="studio">
        <!-- Header -->
        <header class="header">
            <div class="logo">üé¨ Melez Pro Studio</div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="showModal('aiModal')">ü§ñ AI Olu≈ütur</button>
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üìÅ ƒ∞√ße Aktar</button>
                <input type="file" id="fileInput" multiple accept="video/*,image/*,audio/*" style="display: none;" onchange="importFiles(event)">
            </div>

            <div class="header-actions">
                <button class="btn btn-secondary" onclick="playPause()">‚ñ∂Ô∏è Oynat</button>
                <button class="btn btn-primary" onclick="startRender()">üé¨ Render</button>
            </div>
        </header>

        <!-- Workspace -->
        <div class="workspace">
            <!-- Left Panel: Media Library -->
            <div class="panel">
                <div class="panel-header">üìÅ Medya K√ºt√ºphanesi</div>
                <div class="panel-content">
                    <div class="media-grid" id="mediaGrid">
                        <div class="media-item" onclick="addTextClip()">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 2rem;">T</div>
                            <div class="media-label">Metin</div>
                        </div>
                        <div class="media-item" onclick="fetchStockVideo()">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 2rem;">üé•</div>
                            <div class="media-label">Stock Video</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Preview -->
            <div class="preview-area">
                <div class="preview-container">
                    <canvas id="previewCanvas" width="1080" height="1920"></canvas>
                </div>
                <div class="preview-controls">
                    <button class="btn btn-secondary" onclick="skipBackward()">‚èÆ</button>
                    <button class="btn btn-secondary" onclick="playPause()" id="playBtn">‚ñ∂Ô∏è</button>
                    <button class="btn btn-secondary" onclick="skipForward()">‚è≠</button>
                    <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                    <div class="scrubber" onclick="seek(event)">
                        <div class="scrubber-progress" id="scrubberProgress"></div>
                        <div class="scrubber-handle" id="scrubberHandle"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Properties & Effects -->
            <div class="panel">
                <div class="panel-header">‚öôÔ∏è √ñzellikler</div>
                <div class="panel-content" id="propertiesPanel">
                    <div style="color: var(--text-secondary); text-align: center; padding: 40px 0;">
                        Bir klip se√ßin
                    </div>
                </div>
                
                <div class="panel-header" style="border-top: 1px solid var(--border);">‚ú® Efektler</div>
                <div class="panel-content">
                    <div class="effect-category">
                        <div class="effect-title">Ge√ßi≈üler</div>
                        <div class="effect-grid">
                            <div class="effect-item" onclick="addEffect('fade')" title="Fade">üå´Ô∏è</div>
                            <div class="effect-item" onclick="addEffect('slide')" title="Slide">‚û°Ô∏è</div>
                            <div class="effect-item" onclick="addEffect('zoom')" title="Zoom">üîç</div>
                            <div class="effect-item" onclick="addEffect('blur')" title="Blur">üí®</div>
                            <div class="effect-item" onclick="addEffect('glitch')" title="Glitch">‚ö°</div>
                            <div class="effect-item" onclick="addEffect('vhs')" title="VHS">üìº</div>
                        </div>
                    </div>
                    
                    <div class="effect-category">
                        <div class="effect-title">Filtreler</div>
                        <div class="effect-grid">
                            <div class="effect-item" onclick="addFilter('grayscale')" style="filter: grayscale(100%)">‚ö´</div>
                            <div class="effect-item" onclick="addFilter('sepia')" style="filter: sepia(100%)">üü§</div>
                            <div class="effect-item" onclick="addFilter('contrast')" style="filter: contrast(150%)">üî≤</div>
                            <div class="effect-item" onclick="addFilter('vintage')" title="Vintage">üì∑</div>
                            <div class="effect-item" onclick="addFilter('cyber')" title="Cyber">üåÜ</div>
                            <div class="effect-item" onclick="addFilter('noir')" title="Noir">üé≠</div>
                        </div>
                    </div>

                    <div class="effect-category">
                        <div class="effect-title">Metin Efektleri</div>
                        <div class="effect-grid">
                            <div class="effect-item" onclick="addTextEffect('typewriter')">‚å®Ô∏è</div>
                            <div class="effect-item" onclick="addTextEffect('bounce')">‚¨ÜÔ∏è</div>
                            <div class="effect-item" onclick="addTextEffect('glow')">‚ú®</div>
                            <div class="effect-item" onclick="addTextEffect('stroke')">üìù</div>
                            <div class="effect-item" onclick="addTextEffect('3d')">üßä</div>
                            <div class="effect-item" onclick="addTextEffect('neon')">üí°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="timeline">
            <div class="timeline-toolbar">
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="splitClip()">‚úÇÔ∏è B√∂l</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="deleteClip()">üóëÔ∏è Sil</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="duplicateClip()">üìã Kopyala</button>
                <div style="margin-left: auto; display: flex; gap: 5px;">
                    <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="zoomTimeline(-1)">-</button>
                    <span style="font-size: 0.8rem; display: flex; align-items: center;">Zoom</span>
                    <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="zoomTimeline(1)">+</button>
                </div>
            </div>
            
            <div class="timeline-tracks" id="timelineTracks">
                <div class="track">
                    <div class="track-header">üéµ M√ºzik</div>
                    <div class="track-content" id="track-audio"></div>
                </div>
                <div class="track">
                    <div class="track-header">üéôÔ∏è Ses</div>
                    <div class="track-content" id="track-voice"></div>
                </div>
                <div class="track">
                    <div class="track-header">üé¨ Video</div>
                    <div class="track-content" id="track-video"></div>
                </div>
                <div class="track">
                    <div class="track-header">‚ú® Efekt</div>
                    <div class="track-content" id="track-effect"></div>
                </div>
                <div class="track">
                    <div class="track-header">üìù Metin</div>
                    <div class="track-content" id="track-text"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Generation Modal -->
    <div class="modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ü§ñ AI Video Olu≈üturucu</h3>
                <button class="btn btn-secondary" onclick="hideModal('aiModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="ai-prompt-box">
                    <label class="property-label">Video Konusu</label>
                    <textarea id="aiPrompt" placeholder="Ne hakkƒ±nda video istiyorsunuz? √ñrn: '2024'√ºn en iyi teknoloji √ºr√ºnleri, hƒ±zlƒ± kesimler, enerjik m√ºzik'"></textarea>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <select id="aiDuration">
                            <option value="15">15 saniye</option>
                            <option value="30">30 saniye</option>
                            <option value="60" selected>60 saniye</option>
                        </select>
                        <select id="aiStyle">
                            <option value="trendy">Trendy/TikTok</option>
                            <option value="cinematic">Sinema</option>
                            <option value="minimal">Minimal</option>
                            <option value="vlog">Vlog</option>
                        </select>
                    </div>
                    
                    <input type="password" id="aiApiKey" placeholder="Gemini API Key (AIzaSy...)" style="margin-top: 10px;">
                    
                    <button class="generate-btn" onclick="generateAIVideo()">‚ú® Otomatik Video Olu≈ütur</button>
                </div>

                <div id="aiResults" style="display: none;">
                    <h4 style="margin-bottom: 15px;">üé¨ Olu≈üturulan ƒ∞√ßerik</h4>
                    <div id="aiContentList"></div>
                    <button class="btn btn-primary" onclick="applyAIVideo()" style="width: 100%; margin-top: 15px;">Timeline'a Ekle</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Render Progress -->
    <div class="progress-overlay" id="renderOverlay">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px;">Video Render Ediliyor...</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="renderProgress"></div>
        </div>
        <p id="renderStatus" style="color: var(--text-secondary); margin-top: 10px;">Hazƒ±rlanƒ±yor...</p>
    </div>

    <script>
        // ==================== STATE ====================
        let project = {
            timeline: [],
            duration: 0,
            currentTime: 0,
            isPlaying: false,
            selectedClip: null,
            zoom: 1
        };

        let mediaLibrary = [];
        let ffmpeg = null;
        let canvas, ctx;
        let animationId = null;
        let aiGeneratedContent = null;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            canvas = document.getElementById('previewCanvas');
            ctx = canvas.getContext('2d');
            
            // Load FFmpeg
            const { FFmpeg } = FFmpegWASM;
            ffmpeg = new FFmpeg();
            
            try {
                await ffmpeg.load({
                    coreURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.js'
                });
                console.log('FFmpeg ready');
            } catch (e) {
                console.log('FFmpeg will load on demand');
            }

            // Setup canvas
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Start render loop
            renderLoop();
        });

        function resizeCanvas() {
            const container = canvas.parentElement;
            const aspect = 9/16; // Vertical video
            let w = container.clientWidth;
            let h = w / aspect;
            
            if (h > container.clientHeight) {
                h = container.clientHeight;
                w = h * aspect;
            }
            
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
        }

        // ==================== TIMELINE ====================
        function addClip(type, data, start, duration) {
            const clip = {
                id: Date.now(),
                type,
                data,
                start,
                duration,
                effects: [],
                properties: {}
            };
            
            project.timeline.push(clip);
            renderTimeline();
            updateDuration();
            
            return clip;
        }

        function renderTimeline() {
            const tracks = {
                'video': document.getElementById('track-video'),
                'audio': document.getElementById('track-audio'),
                'voice': document.getElementById('track-voice'),
                'text': document.getElementById('track-text'),
                'effect': document.getElementById('track-effect')
            };
            
            // Clear tracks
            Object.values(tracks).forEach(t => t.innerHTML = '');
            
            // Render clips
            project.timeline.forEach(clip => {
                const track = tracks[clip.type] || tracks.video;
                const el = document.createElement('div');
                el.className = 'clip' + (project.selectedClip === clip ? ' selected' : '');
                el.style.left = (clip.start / project.duration * 100) + '%';
                el.style.width = (clip.duration / project.duration * 100) + '%';
                el.textContent = clip.data.name || clip.type;
                el.onclick = (e) => {
                    e.stopPropagation();
                    selectClip(clip);
                };
                track.appendChild(el);
            });
        }

        function selectClip(clip) {
            project.selectedClip = clip;
            renderTimeline();
            showProperties(clip);
        }

        function showProperties(clip) {
            const panel = document.getElementById('propertiesPanel');
            
            panel.innerHTML = `
                <div class="property-group">
                    <label class="property-label">Klip Adƒ±</label>
                    <input type="text" value="${clip.data.name || 'Klip'}" onchange="updateClipName('${clip.id}', this.value)">
                </div>
                
                <div class="property-group">
                    <label class="property-label">Ba≈ülangƒ±√ß: ${clip.start.toFixed(2)}s</label>
                    <input type="range" class="slider" min="0" max="${project.duration}" step="0.1" 
                           value="${clip.start}" oninput="updateClipStart('${clip.id}', this.value)">
                </div>
                
                <div class="property-group">
                    <label class="property-label">S√ºre: ${clip.duration.toFixed(2)}s</label>
                    <input type="range" class="slider" min="0.5" max="30" step="0.1" 
                           value="${clip.duration}" oninput="updateClipDuration('${clip.id}', this.value)">
                </div>
                
                <div class="property-group">
                    <label class="property-label">Opaklƒ±k</label>
                    <input type="range" class="slider" min="0" max="100" 
                           value="${clip.properties.opacity || 100}" 
                           oninput="updateClipProperty('${clip.id}', 'opacity', this.value)">
                </div>
                
                <div class="property-group">
                    <label class="property-label">√ñl√ßek</label>
                    <input type="range" class="slider" min="50" max="200" 
                           value="${(clip.properties.scale || 1) * 100}" 
                           oninput="updateClipProperty('${clip.id}', 'scale', this.value / 100)">
                </div>
            `;
        }

        function updateClipProperty(id, prop, value) {
            const clip = project.timeline.find(c => c.id == id);
            if (clip) {
                clip.properties[prop] = parseFloat(value);
            }
        }

        // ==================== PREVIEW RENDERER ====================
        function renderLoop() {
            if (project.isPlaying) {
                project.currentTime += 1/30; // 30fps
                
                if (project.currentTime > project.duration) {
                    project.currentTime = 0;
                    project.isPlaying = false;
                    document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
                }
                
                updateScrubber();
            }
            
            renderFrame();
            animationId = requestAnimationFrame(renderLoop);
        }

        function renderFrame() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Find active clips
            const activeClips = project.timeline.filter(c => 
                project.currentTime >= c.start && 
                project.currentTime <= c.start + c.duration
            );
            
            // Render clips
            activeClips.forEach(clip => {
                const progress = (project.currentTime - clip.start) / clip.duration;
                renderClip(clip, progress);
            });
            
            // Render playhead indicator
            ctx.strokeStyle = '#e50914';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
        }

        function renderClip(clip, progress) {
            ctx.save();
            
            // Apply effects
            const opacity = (clip.properties.opacity || 100) / 100;
            const scale = clip.properties.scale || 1;
            
            ctx.globalAlpha = opacity;
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.scale(scale, scale);
            ctx.translate(-canvas.width / 2, -canvas.height / 2);
            
            if (clip.type === 'text') {
                renderTextClip(clip, progress);
            } else if (clip.type === 'image') {
                renderImageClip(clip, progress);
            } else if (clip.type === 'video') {
                renderVideoClip(clip, progress);
            } else if (clip.type === 'effect') {
                renderEffect(clip, progress);
            }
            
            ctx.restore();
        }

        function renderTextClip(clip, progress) {
            const text = clip.data.text || 'Metin';
            const fontSize = clip.data.fontSize || 80;
            
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Text effects
            if (clip.data.effect === 'glow') {
                ctx.shadowColor = '#e50914';
                ctx.shadowBlur = 20;
            } else if (clip.data.effect === 'stroke') {
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 8;
                ctx.strokeText(text, canvas.width / 2, canvas.height / 2);
            }
            
            ctx.fillStyle = clip.data.color || '#fff';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        }

        function renderImageClip(clip, progress) {
            if (clip.data.element) {
                const img = clip.data.element;
                const aspect = img.width / img.height;
                let w = canvas.width;
                let h = w / aspect;
                
                if (h > canvas.height) {
                    h = canvas.height;
                    w = h * aspect;
                }
                
                ctx.drawImage(img, (canvas.width - w) / 2, (canvas.height - h) / 2, w, h);
            }
        }

        function renderVideoClip(clip, progress) {
            // Video frame rendering would go here
            ctx.fillStyle = '#333';
            ctx.fillRect(100, 100, canvas.width - 200, canvas.height - 200);
            ctx.fillStyle = '#fff';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üé¨ Video: ' + (clip.data.name || ''), canvas.width / 2, canvas.height / 2);
        }

        function renderEffect(clip, progress) {
            if (clip.data.type === 'fade') {
                ctx.fillStyle = `rgba(0,0,0,${Math.sin(progress * Math.PI)})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (clip.data.type === 'glitch') {
                if (Math.random() > 0.9) {
                    ctx.fillStyle = `rgba(255,0,0,${Math.random() * 0.5})`;
                    ctx.fillRect(Math.random() * canvas.width, 0, 50, canvas.height);
                }
            }
        }

        // ==================== PLAYBACK ====================
        function playPause() {
            project.isPlaying = !project.isPlaying;
            document.getElementById('playBtn').textContent = project.isPlaying ? '‚è∏' : '‚ñ∂Ô∏è';
        }

        function skipBackward() {
            project.currentTime = Math.max(0, project.currentTime - 5);
            updateScrubber();
        }

        function skipForward() {
            project.currentTime = Math.min(project.duration, project.currentTime + 5);
            updateScrubber();
        }

        function seek(event) {
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percent = x / rect.width;
            project.currentTime = percent * project.duration;
            updateScrubber();
        }

        function updateScrubber() {
            const percent = (project.currentTime / project.duration) * 100;
            document.getElementById('scrubberProgress').style.width = percent + '%';
            document.getElementById('scrubberHandle').style.left = percent + '%';
            
            const current = formatTime(project.currentTime);
            const total = formatTime(project.duration);
            document.getElementById('timeDisplay').textContent = `${current} / ${total}`;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateDuration() {
            project.duration = project.timeline.reduce((max, clip) => 
                Math.max(max, clip.start + clip.duration), 0);
            updateScrubber();
        }

        // ==================== AI GENERATION ====================
        async function generateAIVideo() {
            const prompt = document.getElementById('aiPrompt').value;
            const duration = document.getElementById('aiDuration').value;
            const style = document.getElementById('aiStyle').value;
            const apiKey = document.getElementById('aiApiKey').value;

            if (!prompt || !apiKey) {
                alert('L√ºtfen prompt ve API key girin');
                return;
            }

            showProgress('AI i√ßerik olu≈üturuyor...', 0);

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=' + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Sen bir video edit√∂r ve i√ßerik stratejistsin. "${prompt}" konusunda ${duration} saniyelik, ${style} tarzƒ±nda bir video i√ßin detaylƒ± bir senaryo olu≈ütur.

≈ûunlarƒ± saƒüla:
1. Video ba≈ülƒ±ƒüƒ± (ilgi √ßekici, emoji kullan)
2. 3-5 sahne (her biri i√ßin: s√ºre, g√∂rsel a√ßƒ±klamasƒ±, metin/metin, ge√ßi≈ü efekti)
3. √ñnerilen arka plan m√ºziƒüi tarzƒ±
4. Renk paleti ve g√∂rsel stil
5. Metin animasyonlarƒ± ve efektler

Yanƒ±tƒ± JSON formatƒ±nda ver:
{
  "title": "...",
  "scenes": [
    {"duration": 5, "visual": "...", "text": "...", "transition": "..."}
  ],
  "music": "...",
  "colorPalette": ["#...", "#..."],
  "style": "..."
}`
                            }]
                        }],
                        generationConfig: { temperature: 0.8, maxOutputTokens: 2048 }
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // Parse JSON
                let content;
                try {
                    const match = text.match(/```json\s*([\s\S]*?)\s*```/) || [null, text];
                    content = JSON.parse(match[1] || text);
                } catch (e) {
                    content = parseAIResponse(text);
                }

                aiGeneratedContent = content;
                
                // Display results
                document.getElementById('aiResults').style.display = 'block';
                document.getElementById('aiContentList').innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h4 style="color: var(--accent); margin-bottom: 10px;">${content.title}</h4>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${content.scenes.map((s, i) => `
                                <div style="margin-bottom: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                    <strong>Sahne ${i+1}</strong> (${s.duration}s)<br>
                                    üé¨ ${s.visual}<br>
                                    üìù ${s.text}<br>
                                    ‚ú® ${s.transition}
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85rem;">
                            üéµ ${content.music}<br>
                            üé® ${content.colorPalette.join(', ')}
                        </div>
                    </div>
                `;

                hideProgress();

            } catch (error) {
                hideProgress();
                alert('Hata: ' + error.message);
            }
        }

        function parseAIResponse(text) {
            // Fallback parser
            return {
                title: 'AI Generated Video',
                scenes: [
                    { duration: 10, visual: 'Stock footage', text: 'Introduction', transition: 'fade' },
                    { duration: 10, visual: 'Product showcase', text: 'Main content', transition: 'slide' },
                    { duration: 10, visual: 'Call to action', text: 'Subscribe', transition: 'zoom' }
                ],
                music: 'Upbeat electronic',
                colorPalette: ['#e50914', '#141414'],
                style: 'modern'
            };
        }

        function applyAIVideo() {
            if (!aiGeneratedContent) return;
            
            // Clear existing timeline
            project.timeline = [];
            
            let currentTime = 0;
            
            // Add scenes
            aiGeneratedContent.scenes.forEach((scene, index) => {
                // Add video clip
                addClip('video', {
                    name: `Sahne ${index + 1}`,
                    description: scene.visual
                }, currentTime, scene.duration);
                
                // Add text overlay
                addClip('text', {
                    text: scene.text,
                    fontSize: 60,
                    color: '#fff',
                    effect: index % 2 === 0 ? 'glow' : 'stroke'
                }, currentTime + 1, scene.duration - 2);
                
                // Add transition effect
                if (index > 0) {
                    addClip('effect', {
                        type: scene.transition.toLowerCase().includes('fade') ? 'fade' : 'glitch'
                    }, currentTime, 0.5);
                }
                
                currentTime += scene.duration;
            });
            
            hideModal('aiModal');
            updateDuration();
        }

        // ==================== MEDIA IMPORT ====================
        function importFiles(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                const type = file.type.startsWith('video') ? 'video' : 
                            file.type.startsWith('image') ? 'image' : 'audio';
                
                const media = {
                    id: Date.now(),
                    name: file.name,
                    type,
                    url,
                    file
                };
                
                mediaLibrary.push(media);
                addToMediaGrid(media);
            });
        }

        function addToMediaGrid(media) {
            const grid = document.getElementById('mediaGrid');
            const item = document.createElement('div');
            item.className = 'media-item';
            
            if (media.type === 'video') {
                item.innerHTML = `<video src="${media.url}" muted></video><div class="media-label">${media.name}</div>`;
            } else if (media.type === 'image') {
                item.innerHTML = `<img src="${media.url}"><div class="media-label">${media.name}</div>`;
            } else {
                item.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%;">üéµ</div><div class="media-label">${media.name}</div>`;
            }
            
            item.onclick = () => importToTimeline(media);
            grid.appendChild(item);
        }

        function importToTimeline(media) {
            if (media.type === 'video' || media.type === 'image') {
                const element = media.type === 'image' ? new Image() : document.createElement('video');
                element.src = media.url;
                if (media.type === 'image') element.onload = () => {};
                
                addClip(media.type, {
                    name: media.name,
                    element: element,
                    url: media.url
                }, project.currentTime, 5);
            }
        }

        function addTextClip() {
            const text = prompt('Metin girin:', 'Merhaba D√ºnya!');
            if (text) {
                addClip('text', {
                    text,
                    fontSize: 80,
                    color: '#fff',
                    effect: 'glow'
                }, project.currentTime, 3);
            }
        }

        async function fetchStockVideo() {
            const query = prompt('Ne aramak istersiniz?', 'technology');
            if (!query) return;
            
            // Use Pexels API (demo key)
            try {
                const response = await fetch(`https://api.pexels.com/videos/search?query=${query}&per_page=5`, {
                    headers: { 'Authorization': '563492ad6f91700001000001f8c8a0e1a6a94c9b' }
                });
                
                const data = await response.json();
                
                if (data.videos && data.videos.length > 0) {
                    const video = data.videos[0];
                    const media = {
                        id: Date.now(),
                        name: query + ' stock',
                        type: 'video',
                        url: video.video_files[0].link
                    };
                    mediaLibrary.push(media);
                    addToMediaGrid(media);
                }
            } catch (e) {
                alert('Stock video alƒ±namadƒ±. Kendi videonuzu y√ºkleyin.');
            }
        }

        // ==================== EFFECTS ====================
        function addEffect(type) {
            if (!project.selectedClip) {
                alert('√ñnce bir klip se√ßin');
                return;
            }
            
            addClip('effect', { type }, project.selectedClip.start, 1);
        }

        function addFilter(type) {
            if (!project.selectedClip) return;
            project.selectedClip.properties.filter = type;
        }

        function addTextEffect(effect) {
            if (!project.selectedClip || project.selectedClip.type !== 'text') {
                alert('√ñnce bir metin klipi se√ßin');
                return;
            }
            project.selectedClip.data.effect = effect;
        }

        // ==================== EDITING ====================
        function splitClip() {
            if (!project.selectedClip) return;
            
            const clip = project.selectedClip;
            const splitPoint = project.currentTime - clip.start;
            
            if (splitPoint <= 0 || splitPoint >= clip.duration) return;
            
            // Create second part
            const newClip = {
                ...clip,
                id: Date.now(),
                start: project.currentTime,
                duration: clip.duration - splitPoint
            };
            
            // Adjust first part
            clip.duration = splitPoint;
            
            project.timeline.push(newClip);
            renderTimeline();
        }

        function deleteClip() {
            if (!project.selectedClip) return;
            
            project.timeline = project.timeline.filter(c => c !== project.selectedClip);
            project.selectedClip = null;
            renderTimeline();
            updateDuration();
            
            document.getElementById('propertiesPanel').innerHTML = `
                <div style="color: var(--text-secondary); text-align: center; padding: 40px 0;">
                    Bir klip se√ßin
                </div>
            `;
        }

        function duplicateClip() {
            if (!project.selectedClip) return;
            
            const newClip = {
                ...project.selectedClip,
                id: Date.now(),
                start: project.selectedClip.start + project.selectedClip.duration
            };
            
            project.timeline.push(newClip);
            renderTimeline();
            updateDuration();
        }

        function zoomTimeline(direction) {
            project.zoom = Math.max(0.5, Math.min(3, project.zoom + direction * 0.5));
            // Apply zoom to timeline rendering
        }

        // ==================== RENDER ====================
        async function startRender() {
            if (!ffmpeg.loaded) {
                showProgress('FFmpeg y√ºkleniyor...', 0);
                await ffmpeg.load();
            }

            showProgress('Video render ediliyor...', 0);
            
            try {
                // This is a simplified render - in production you'd render frame by frame
                updateProgress(50, 'Kareler i≈üleniyor...');
                
                // Create video from canvas frames
                const frames = [];
                const fps = 30;
                const totalFrames = project.duration * fps;
                
                for (let i = 0; i < totalFrames; i++) {
                    project.currentTime = i / fps;
                    renderFrame();
                    
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
                    const buffer = await blob.arrayBuffer();
                    await ffmpeg.writeFile(`frame_${i.toString().padStart(5, '0')}.jpg`, new Uint8Array(buffer));
                    
                    if (i % 10 === 0) {
                        updateProgress((i / totalFrames) * 80, `Kare ${i}/${totalFrames}`);
                    }
                }
                
                updateProgress(85, 'Video kodlanƒ±yor...');
                
                // Render final video
                await ffmpeg.exec([
                    '-framerate', '30',
                    '-pattern_type', 'glob',
                    '-i', '*.jpg',
                    '-c:v', 'libx264',
                    '-pix_fmt', 'yuv420p',
                    '-preset', 'ultrafast',
                    'output.mp4'
                ]);
                
                updateProgress(95, 'Sonlandƒ±rƒ±lƒ±yor...');
                
                // Download
                const data = await ffmpeg.readFile('output.mp4');
                const blob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `melez_video_${Date.now()}.mp4`;
                a.click();
                
                // Cleanup
                await ffmpeg.deleteDir('.');
                
                hideProgress();
                alert('‚úÖ Video indirildi!');
                
            } catch (error) {
                hideProgress();
                alert('Render hatasƒ±: ' + error.message);
                console.error(error);
            }
        }

        // ==================== UTILITIES ====================
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showProgress(title, percent) {
            document.getElementById('renderOverlay').classList.add('active');
            document.querySelector('#renderOverlay h3').textContent = title;
            updateProgress(percent, '');
        }

        function updateProgress(percent, status) {
            document.getElementById('renderProgress').style.width = percent + '%';
            if (status) document.getElementById('renderStatus').textContent = status;
        }

        function hideProgress() {
            document.getElementById('renderOverlay').classList.remove('active');
        }
    </script>
</body>
</html>